"""
SpectreFlow — Test Malware Simulator
A SAFE script that mimics suspicious behaviour so you can demo your
dynamic analyzer without needing real malware.

What it does:
  1. Burns CPU in a tight loop            → triggers cpu_spike
  2. Creates a temp .exe file             → triggers file_activity
  3. Opens a TCP socket to localhost:8080  → triggers network_activity
"""

import os
import sys
import time
import socket
import tempfile
import threading


def burn_cpu(seconds: float = 8):
    """Consume CPU for *seconds* to trigger a spike."""
    end = time.time() + seconds
    while time.time() < end:
        _ = sum(i * i for i in range(10_000))


def create_suspicious_file():
    """Drop a fake .exe in the system temp directory."""
    temp_dir = tempfile.gettempdir()
    path = os.path.join(temp_dir, "temp.exe")
    with open(path, "w") as f:
        f.write("This is a harmless test file created by SpectreFlow.\n")
    print(f"[test_malware] Created file: {path}")
    return path


def make_network_connection():
    """Attempt a TCP connection to localhost:8080 (will likely refuse,
    but psutil still records the attempt)."""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(3)
        sock.connect(("127.0.0.1", 8080))
        print("[test_malware] Connected to 127.0.0.1:8080")
        time.sleep(5)
        sock.close()
    except OSError:
        # Connection refused is expected — we still want the attempt
        # to show up in net_connections().
        print("[test_malware] Connection to 127.0.0.1:8080 refused (expected)")


def main():
    print("[test_malware] Starting simulated suspicious behaviour ...")

    # Start CPU burn in a thread (runs in background)
    cpu_thread = threading.Thread(target=burn_cpu, args=(10,), daemon=True)
    cpu_thread.start()

    # Create suspicious file
    temp_file = create_suspicious_file()

    # Attempt network connection
    make_network_connection()

    # Keep alive so monitors have time to observe us
    print("[test_malware] Sleeping for 15s so monitors can observe ...")
    time.sleep(15)

    # Clean up
    try:
        os.remove(temp_file)
        print(f"[test_malware] Cleaned up {temp_file}")
    except OSError:
        pass

    print("[test_malware] Done.")


if __name__ == "__main__":
    main()
