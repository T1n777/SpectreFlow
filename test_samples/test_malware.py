"""
Test Malware Simulation for SpectreFlow
Expected: SUSPICIOUS, HIGH risk
Simulates: keylogging, C2 connection, file exfiltration, persistence
"""
import socket
import time
import hashlib
import tempfile
import os
import subprocess
import sys
import threading

print("=== MALWARE SIMULATION STARTED ===")


# simulate keylogger by doing heavy cpu work (encoding keystrokes)
def keylogger_sim():
    print("[KEYLOG] Simulating keystroke capture...")
    captured = ""
    for i in range(300000):
        captured += hashlib.md5(str(i).encode()).hexdigest()[:1]
        if i % 100000 == 0:
            print(f"[KEYLOG] Captured {i} events")
    print("[KEYLOG] Done")


# simulate command and control server connection
def c2_connection():
    print("[C2] Connecting to command & control servers...")
    c2_ports = [4444, 5555, 1337, 31337, 8080]
    for port in c2_ports:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(0.5)
            sock.connect_ex(("127.0.0.1", port))
            print(f"[C2] Attempted connection to 127.0.0.1:{port}")
            sock.close()
        except:
            pass
        time.sleep(0.3)
    print("[C2] Done")


# simulate dropping malicious files
def drop_payloads():
    print("[DROP] Dropping payload files...")
    temp_dir = tempfile.gettempdir()
    payloads = [
        "update.exe",
        "svchost_helper.dll",
        "cleanup.bat",
        "persist.vbs",
        "loader.ps1",
        "data.hta",
    ]
    created_files = []
    for filename in payloads:
        try:
            path = os.path.join(temp_dir, filename)
            with open(path, "w") as f:
                # write fake payload content
                f.write(f"REM fake payload: {filename}\n")
                f.write("echo simulated malware payload\n")
            created_files.append(path)
            print(f"[DROP] Created {filename}")
            time.sleep(0.2)
        except:
            pass

    # clean up after ourselves
    time.sleep(1)
    for path in created_files:
        try:
            os.remove(path)
        except:
            pass
    print("[DROP] Done (files cleaned up)")


# simulate spawning processes for persistence and recon
def spawn_recon():
    print("[RECON] Spawning reconnaissance processes...")
    commands = []
    if sys.platform == "win32":
        commands = [
            ["ping", "-n", "2", "127.0.0.1"],
            ["hostname"],
            ["whoami"],
        ]
    else:
        commands = [
            ["ping", "-c", "2", "127.0.0.1"],
            ["hostname"],
            ["whoami"],
        ]

    for cmd in commands:
        try:
            proc = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )
            proc.wait(timeout=5)
            print(f"[RECON] Ran: {' '.join(cmd)}")
        except:
            pass
        time.sleep(0.3)
    print("[RECON] Done")


# simulate data exfiltration attempt
def exfiltrate_data():
    print("[EXFIL] Simulating data exfiltration...")
    # create a temp file with "stolen" data
    temp_dir = tempfile.gettempdir()
    stolen_path = os.path.join(temp_dir, "stolen_data.txt")
    try:
        with open(stolen_path, "w") as f:
            for i in range(100):
                f.write(f"stolen_record_{i}: {hashlib.sha256(str(i).encode()).hexdigest()}\n")
        print("[EXFIL] Data file written")

        # try to send it over network
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(0.5)
            sock.connect_ex(("127.0.0.1", 9090))
            sock.close()
            print("[EXFIL] Exfiltration connection attempted")
        except:
            pass

        # clean up
        os.remove(stolen_path)
    except:
        pass
    print("[EXFIL] Done")


# run everything in parallel like real malware would
threads = [
    threading.Thread(target=keylogger_sim),
    threading.Thread(target=c2_connection),
    threading.Thread(target=drop_payloads),
    threading.Thread(target=spawn_recon),
    threading.Thread(target=exfiltrate_data),
]

for t in threads:
    t.start()

for t in threads:
    t.join()

print("=== MALWARE SIMULATION COMPLETE ===")
