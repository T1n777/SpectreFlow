/*
 * Test malware simulation for SpectreFlow static analysis
 * This creates a binary with suspicious control flow patterns:
 *   - Anti-debugging checks
 *   - Network socket setup
 *   - File operations
 *   - Multiple branches and loops
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/* simulate checking if a debugger is attached */
int check_debugger() {
    int suspicious = 0;
    char *env = getenv("DEBUG");
    if (env != NULL) {
        suspicious = 1;
    }
    return suspicious;
}

/* simulate decoding a hidden command */
void decode_payload(char *buffer, int size) {
    int i;
    for (i = 0; i < size; i++) {
        buffer[i] = buffer[i] ^ 0x41;
    }
}

/* simulate network callback to c2 server */
int connect_c2(const char *host, int port) {
    printf("[C2] Attempting connection to %s:%d\n", host, port);
    /* we dont actually connect, just simulate the control flow */
    if (port == 4444) {
        return 1;
    } else if (port == 1337) {
        return 1;
    } else {
        return 0;
    }
}

/* simulate writing a dropped file */
void drop_file(const char *filename) {
    FILE *f = fopen(filename, "w");
    if (f != NULL) {
        fprintf(f, "payload data\n");
        fclose(f);
        printf("[DROP] Wrote %s\n", filename);
        /* clean up */
        remove(filename);
    } else {
        printf("[DROP] Failed to write %s\n", filename);
    }
}

/* simulate persistence mechanism */
void install_persistence() {
    printf("[PERSIST] Simulating persistence install...\n");
    int i;
    int retry_count = 5;
    for (i = 0; i < retry_count; i++) {
        printf("[PERSIST] Attempt %d/%d\n", i + 1, retry_count);
        if (i == 3) {
            printf("[PERSIST] Installed\n");
            break;
        }
    }
}

/* simulate data collection loop */
void collect_data() {
    printf("[COLLECT] Gathering system info...\n");
    int total = 0;
    int i, j;
    for (i = 0; i < 100; i++) {
        for (j = 0; j < 100; j++) {
            total += i * j;
        }
    }
    printf("[COLLECT] Gathered %d records\n", total);
}

int main() {
    printf("=== MALWARE SIMULATION (C) ===\n");

    /* phase 1: environment checks */
    int is_debugged = check_debugger();
    if (is_debugged) {
        printf("[!] Debugger detected, aborting\n");
        return 1;
    }
    printf("[OK] No debugger detected\n");

    /* phase 2: decode payload */
    char payload[] = "secret_message";
    decode_payload(payload, strlen(payload));
    printf("[DECODE] Payload decoded\n");

    /* phase 3: connect to c2 */
    int connected = 0;
    int ports[] = {4444, 1337, 8080};
    int num_ports = 3;
    int p;
    for (p = 0; p < num_ports; p++) {
        if (connect_c2("127.0.0.1", ports[p])) {
            connected = 1;
            break;
        }
    }

    if (connected) {
        printf("[C2] Connection established\n");

        /* phase 4: drop files */
        drop_file("temp_payload.exe");
        drop_file("helper.dll");

        /* phase 5: persistence */
        install_persistence();

        /* phase 6: collect and exfiltrate */
        collect_data();
    } else {
        printf("[C2] All connections failed\n");
        /* fallback: just collect data locally */
        collect_data();
    }

    printf("=== SIMULATION COMPLETE ===\n");
    return 0;
}
