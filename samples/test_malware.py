"""
SpectreFlow — Test Malware Simulator
A SAFE script that mimics suspicious behaviour so you can demo your
dynamic analyzer without needing real malware.

What it does:
  1. Burns CPU in a tight loop            → triggers cpu_spike
  2. Creates a temp .exe file             → triggers file_activity
  3. Opens a TCP socket to localhost:8080  → triggers network_activity
"""

import os
import sys
import time
import socket
import tempfile
import threading


def burn_cpu(seconds: float = 12):
    """Consume CPU for *seconds* to trigger a spike.

    Uses a raw arithmetic loop (no generators) so it saturates a core
    even when compiled with PyInstaller.
    """
    end = time.time() + seconds
    x = 0
    while time.time() < end:
        for i in range(500_000):
            x += i * i
        # Don't let the compiler optimise *x* away
        if x < 0:
            break


def create_suspicious_file():
    """Drop a fake .exe in the system temp directory."""
    temp_dir = tempfile.gettempdir()
    path = os.path.join(temp_dir, "temp.exe")
    with open(path, "w") as f:
        f.write("This is a harmless test file created by SpectreFlow.\n")
    print(f"[test_malware] Created file: {path}")
    return path


def make_network_connection():
    """Start a lightweight TCP server on localhost and connect to it,
    keeping the connection alive so psutil can observe it.

    This guarantees a visible ESTABLISHED connection even when
    no external service is running on port 8080.
    """
    ready = threading.Event()

    def _server():
        srv = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        srv.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        srv.bind(("127.0.0.1", 8080))
        srv.listen(1)
        ready.set()
        conn, _ = srv.accept()
        # Hold the connection open
        time.sleep(20)
        conn.close()
        srv.close()

    server_thread = threading.Thread(target=_server, daemon=True)
    server_thread.start()
    ready.wait()  # wait until server is listening

    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect(("127.0.0.1", 8080))
        print("[test_malware] Connected to 127.0.0.1:8080")
        # Keep connection alive for the entire monitoring window
        time.sleep(18)
        sock.close()
    except OSError as e:
        print(f"[test_malware] Connection error: {e}")


def main():
    print("[test_malware] Starting simulated suspicious behaviour ...")

    # Start CPU burn in a thread (runs in background)
    cpu_thread = threading.Thread(target=burn_cpu, args=(12,), daemon=True)
    cpu_thread.start()

    # Create suspicious file
    temp_file = create_suspicious_file()

    # Establish persistent network connection
    net_thread = threading.Thread(target=make_network_connection, daemon=True)
    net_thread.start()

    # Keep alive so monitors have time to observe us
    print("[test_malware] Sleeping for 18s so monitors can observe ...")
    time.sleep(18)

    # Clean up
    try:
        os.remove(temp_file)
        print(f"[test_malware] Cleaned up {temp_file}")
    except OSError:
        pass

    print("[test_malware] Done.")


if __name__ == "__main__":
    main()
